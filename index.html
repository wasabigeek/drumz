<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Over the Kit</title>
  <script type="text/javascript" src="js/bufferLoader.js"></script>
  <script type="text/javascript" src="https://unpkg.com/vexflow@3.0.9/releases/vexflow-min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/tailwindcss@^1.5/dist/base.min.css">
  <link rel="stylesheet" href="https://unpkg.com/tailwindcss@^1.5/dist/components.min.css">
  <link rel="stylesheet" href="https://unpkg.com/@tailwindcss/typography@0.2.x/dist/typography.min.css">
  <link rel="stylesheet" href="https://unpkg.com/tailwindcss@^1.5/dist/utilities.min.css">
</head>
<body class="bg-gray-200">
  <div class="container mx-auto prose prose-lg text-center py-10">
    <div class="shadow-md rounded bg-white py-12 px-10 md:px-16">
      <h1>Over the Kit</h1>
      <div class="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-10 md:hidden" role="alert">
        <span class="font-bold">On a mobile device?</span>
        <span>Remember to turn off silent mode!</span>
      </div>
      <div class="flex flex-col space-y-10">
        <div class="mw-1/2">Shuffle through different voicings of a sticking pattern and hear them played at speed.</div>

        <form id="playerForm" class="my-4 space-y-10 md:space-y-4">
          <div class="md:flex md:items-center md:justify-center">
            <div class="md:w-1/3">
              <label class="block text-gray-500 font-bold md:text-right mb-1 md:mb-0 pr-4" for="sticking">
                Sticking:
              </label>
            </div>
            <div class="md:w-2/3">
              <input
                id="sticking"
                value="RLKRLKRLKRLKRLRL"
                maxlength="16"
                minlength="16"
                class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-purple-500"
                type="text"
              >
            </div>
          </div>
          <div class="md:flex md:items-start">
            <div class="md:w-1/3">
              <label class="block text-gray-500 font-bold md:text-right mb-1 md:mb-0 pr-4" for="sticking">
                Orchestrations:
              </label>
            </div>
            <div class="md:w-2/3 pl-2 text-left">
              <div class="mb-2 flex">
                <div class="w-1/2">
                  <label class="md:w-full block text-gray-500 font-bold">
                    <input id="hihatCheckbox" class="mr-2 leading-tight" checked type="checkbox">
                    <span class="text-sm">
                      Hi-Hat
                    </span>
                  </label>
                </div>
                <div class="w-1/2">
                  <label class="md:w-full block text-gray-500 font-bold">
                    <input id="snareCheckbox" class="mr-2 leading-tight" checked type="checkbox">
                    <span class="text-sm">
                      Snare
                    </span>
                  </label>
                </div>
              </div>
              <div class="mb-2 flex">
                <div class="w-1/2">
                  <label class="md:w-full block text-gray-500 font-bold">
                    <input id="hiTomCheckbox" class="mr-2 leading-tight" checked type="checkbox">
                    <span class="text-sm">
                      Hi-Tom
                    </span>
                  </label>
                </div>
                <div class="w-1/2">
                  <label class="md:w-full block text-gray-500 font-bold">
                    <input id="midTomCheckbox" class="mr-2 leading-tight" type="checkbox">
                    <span class="text-sm">
                      Mid-Tom
                    </span>
                  </label>
                </div>
              </div>
              <div class="mb-2 flex">
                <div class="w-1/2">
                  <label class="md:w-full block text-gray-500 font-bold">
                    <input id="floorTomCheckbox" class="mr-2 leading-tight" checked type="checkbox">
                    <span class="text-sm">
                      Floor-Tom
                    </span>
                  </label>
                </div>
                <div class="w-1/2">
                  <label class="md:w-full block text-gray-500 font-bold">
                    <input class="mr-2 leading-tight" type="checkbox" checked disabled>
                    <span class="text-sm">
                      Kick
                    </span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="md:flex md:items-center md:justify-center">
            <div class="md:w-1/3">
              <label class="block text-gray-500 font-bold md:text-right mb-1 md:mb-0 pr-4" for="sticking">
                Tempo:
              </label>
            </div>
            <div class="md:w-2/3 mb-4 md:mb-auto">
              <input
                id="tempo"
                value="120"
                max="400"
                type="number"
                class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-purple-500"
              >
            </div>
          </div>
          <div class="md:flex md:items-center">
            <div class="md:w-1/3 hidden md:block">&nbsp;</div>
            <div class="md:w-2/3 text-left">
              <button class="shadow bg-purple-500 hover:bg-purple-400 focus:shadow-outline focus:outline-none text-white font-bold py-2 px-4 rounded w-full md:w-auto inline-flex items-center justify-center" type="submit">
                <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path class="heroicon-ui" d="M8 14.54V6a1 1 0 0 1 .76-.97l12-3A1 1 0 0 1 22 3v12a4 4 0 1 1-2-3.46V4.28l-10 2.5V18a4 4 0 1 1-2-3.46zM6 20a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm12-3a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>
                <span>Shuffle & Play</span>
              </button>
              <button id="repeat" class="shadow bg-gray-200 hover:bg-purple-200 focus:shadow-outline focus:outline-none text-purple-600 font-bold py-2 px-4 rounded w-full md:w-auto inline-flex items-center justify-center md:ml-2 mt-2 md:mt-auto" type="button">
                <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path class="heroicon-ui" d="M6 18.7V21a1 1 0 0 1-2 0v-5a1 1 0 0 1 1-1h5a1 1 0 1 1 0 2H7.1A7 7 0 0 0 19 12a1 1 0 1 1 2 0 9 9 0 0 1-15 6.7zM18 5.3V3a1 1 0 0 1 2 0v5a1 1 0 0 1-1 1h-5a1 1 0 0 1 0-2h2.9A7 7 0 0 0 5 12a1 1 0 1 1-2 0 9 9 0 0 1 15-6.7z"/></svg>
                <span>Repeat</span>
              </button>
            </div>
          </div>
        </form>
        <div id="score" class="flex justify-center border-solid border-t border-gray-300 pt-8"></div>
      </div>
    </div>
    <p class="text-center text-gray-500">
      Have a <a class="underline hover:text-gray-700" href="https://forms.gle/R4ZryX4fbvmBrz5TA" target="_blank" rel="noopener noreferrer">suggestion</a>?
    </p>
  </div>
  <script type="text/javascript">
    window.onload = init;
    var context;
    var drumkit;
    var score = [];
    var VF = Vex.Flow;
    var vf = new VF.Factory({
      renderer: {
        elementId: "score",
        backend: VF.Renderer.Backends.SVG,
        width: 450,
        height: 120,
      },
    });

    function Instrument(options) {
      this.verticalPosition = options.verticalPosition;
      this.sound = options.sound;
    }

    function Note(options) {
      this.instrument = options.instrument;
      this.volume = options.volume;

      this.verticalPosition = this.instrument.verticalPosition;
      // this has to be lazily retrieved now because the AudioContext needs to load
      this.getSound = this.instrument.sound;
    }
    DURATION_SIXTEENTH = 'sixteenth';
    DURATION_EIGHTH = 'eighth';
    DURATION_QUARTER = 'quarter';
    function NoteGroup(notes, duration) {
      this.notes = notes;
      this.duration = duration;

    }

    function toNotation(noteGroup) {
      var keys = noteGroup.notes.map(function(note) { return note.verticalPosition });

      var vfDuration;
      switch (noteGroup.duration) {
        case DURATION_EIGHTH:
          vfDuration = '8';
          break;
        case DURATION_SIXTEENTH:
          vfDuration = '16';
          break;
        default:
          break;
      }

      return {
        keys: keys,
        duration: vfDuration
      }
    }

    function createMeasure(setup) {
      var stave = vf.Stave().addClef('percussion');

      if (score.length > 0) {
        setup(vf);

        vf.Formatter()
              .joinVoices(vf.getVoices())
              .formatToStave(vf.getVoices(), stave);
      }

      vf.draw();
    }

    function generateNotation(score) {
      var context = vf.getContext()
      context.clear();

      createMeasure(function(vf) {
        var voice0 = vf.Voice().addTickables(
          score.map(function(noteGroup) {
            return vf.StaveNote(toNotation(noteGroup));
          })
        );

        vf.Beam({ notes: voice0.getTickables() });
      });
    }

    // score (bars, play marker?, )
    // bar (notes by positions?)
    // note (duration, volume, instrument (voice + chart position))
    // rendering
    // player

    // flams/drags? rolls? ghost notes (maybe that's an instrument? since it has a voice attached to it)?

    function init() {
      // Fix up prefixing
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      context = new AudioContext();

      drumkit = new DrumKit(context);

      var snareInstrument = new Instrument({ verticalPosition: 'c/5', sound: drumkit.snareSound })
      var hihatInstrument = new Instrument({ verticalPosition: 'g/5/x2', sound: drumkit.hihatSound })
      var kickInstrument = new Instrument({ verticalPosition: 'f/4', sound: drumkit.kickSound })
      var tom1Instrument = new Instrument({ verticalPosition: 'e/5', sound: drumkit.tom1Sound })
      var tom2Instrument = new Instrument({ verticalPosition: 'd/5', sound: drumkit.tom2Sound })
      var tom3Instrument = new Instrument({ verticalPosition: 'a/4', sound: drumkit.tom3Sound })
      function getOrchestrations() {
        var orchestrations = [];
        // this is coupled to the UI / instruments for simplicity, might want to relook this
        if (document.getElementById('hihatCheckbox').checked) { orchestrations.push(hihatInstrument) }
        if (document.getElementById('snareCheckbox').checked) { orchestrations.push(snareInstrument) }
        if (document.getElementById('hiTomCheckbox').checked) { orchestrations.push(tom1Instrument) }
        if (document.getElementById('midTomCheckbox').checked) { orchestrations.push(tom2Instrument) }
        if (document.getElementById('floorTomCheckbox').checked) { orchestrations.push(tom3Instrument) }

        return orchestrations;
      }

      function generateScore(sticking, options = {}) {
        var newScore = [];
        var orchestrations = options.orchestrations || getOrchestrations();

        for (var stick of sticking) {
          var note;
          // attempt to make it sound slightly more organic with volume variations
          var volume = 1 - Math.random() * 0.2;

          if (stick.toUpperCase() == 'K') {
            note = new Note({ instrument: kickInstrument, volume: volume });
          } else {
            var instrument = orchestrations[Math.round(Math.random() * (orchestrations.length - 1))];
            note = new Note({ instrument: instrument, volume: volume });
          }

          newScore.push(new NoteGroup([note], DURATION_SIXTEENTH));
        }

        return newScore;
      }


      generateNotation(score);

      document.getElementById('repeat').onclick = function(e) {
        if (score.length <= 0) {
          alert('No orchestration generated yet! Please Shuffle & Play first.')
        }
        var tempo = document.getElementById('tempo').value;
        RhythmSample.play(drumkit, score, tempo);
      }

      document.getElementById('playerForm').onsubmit = function(e) {
        e.preventDefault();
        var newSticking = document.getElementById('sticking').value;
        var orchestrations = getOrchestrations();

        score = generateScore(newSticking, { orchestrations: orchestrations });
        if (score.length < 16) {
          alert('Must have 16 notes!');
          return;
        }

        generateNotation(score);
        var tempo = document.getElementById('tempo').value;
        RhythmSample.play(drumkit, score, tempo)
      }
    }

    function DrumKit(audioContext) {
      this.loader = new BufferLoader(
        audioContext,
        [
          'acoustic-kit/kick.wav',
          'acoustic-kit/snare.wav',
          'acoustic-kit/hihat.wav',
          'acoustic-kit/tom1.wav',
          'acoustic-kit/tom2.wav',
          'acoustic-kit/tom3.wav',
        ]
        );
      this.loader.load();

      // functions since they are asynchronously loaded
      kickSound = function() { return this.loader.bufferList[0] };
      snareSound = function() { return this.loader.bufferList[1] };
      hihatSound = function() { return this.loader.bufferList[2] };
      tom1Sound = function() { return this.loader.bufferList[3] };
      tom2Sound = function() { return this.loader.bufferList[4] };
      tom3Sound = function() { return this.loader.bufferList[5] };
      this.kickSound = kickSound.bind(this);
      this.snareSound = snareSound.bind(this);
      this.hihatSound = hihatSound.bind(this);
      this.tom1Sound = tom1Sound.bind(this);
      this.tom2Sound = tom2Sound.bind(this);
      this.tom3Sound = tom3Sound.bind(this);
    }

    var RhythmSample = {
    };

    function timeInTempo(duration, tempo) {
      switch (duration) {
        case DURATION_EIGHTH:
          return (60 / tempo) / 2;
          break;
        case DURATION_SIXTEENTH:
          return (60 / tempo) / 4;
          break;
        default:
          break;
      }
    }

    RhythmSample.play = function(drumkit, score, tempo) {
      function playSound(buffer, time, volume = 1) {

        var source = context.createBufferSource();
        source.buffer = buffer;

        var gainNode = context.createGain();
        gainNode.gain.setValueAtTime(volume, time);
        source.connect(gainNode);

        gainNode.connect(context.destination);

        if (!source.start) {
          source.start = source.noteOn;
        }
        source.start(time);
      }

      // We'll start playing the rhythm 100 milliseconds from "now"
      var startTime = context.currentTime + 0.100;

      var cumulativeTime = startTime;
      var plays = score.forEach(function(noteGroup) {
        var time = timeInTempo(noteGroup.duration, tempo);
        noteGroup.notes.forEach(function(note) {
          playSound(note.getSound(), cumulativeTime, note.volume);
        });
        cumulativeTime += time;
      });
    };
  </script>
</body>
</html>