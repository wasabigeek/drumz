<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script type="text/javascript" src="/js/bufferLoader.js"></script>
</head>
<body>
  <button id="play">Play</button>
  <script type="text/javascript">
    window.onload = init;
    var context;
    var drumkit;

    document.getElementById('play').onclick = function() { RhythmSample.play(drumkit) }

    function init() {
      // Fix up prefixing
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      context = new AudioContext();

      drumkit = new DrumKit(context);
    }

    function DrumKit(audioContext) {
      this.loader = new BufferLoader(
        audioContext,
        [
          '/acoustic-kit/kick.wav',
          '/acoustic-kit/snare.wav',
          '/acoustic-kit/hihat.wav',
        ]
        );
      this.loader.load();

      // functions since they are asynchronously loaded
      this.kickSound = function() { return this.loader.bufferList[0] };
      this.snareSound = function() { return this.loader.bufferList[1] };
      this.hihatSound = function() { return this.loader.bufferList[2] };
    }

    // function DrumMachine(kit) {
    //   this.kit =
    // }

    var RhythmSample = {
    };

    RhythmSample.play = function(drumkit) {
      function playSound(buffer, time) {
        var source = context.createBufferSource();
        source.buffer = buffer;
        source.connect(context.destination);
        if (!source.start) {
          source.start = source.noteOn;
        }
        source.start(time);
      }

      var kick = drumkit.kickSound();
      var snare = drumkit.snareSound();
      var hihat = drumkit.hihatSound();

      // We'll start playing the rhythm 100 milliseconds from "now"
      var startTime = context.currentTime + 0.100;
      var tempo = 80; // BPM (beats per minute)
      var eighthNoteTime = (60 / tempo) / 2;

      // Play 2 bars of the following:
      for (var bar = 0; bar < 2; bar++) {
        var time = startTime + bar * 8 * eighthNoteTime;
        // Play the bass (kick) drum on beats 1, 5
        playSound(kick, time);
        playSound(kick, time + 4 * eighthNoteTime);

        // Play the snare drum on beats 3, 7
        playSound(snare, time + 2 * eighthNoteTime);
        playSound(snare, time + 6 * eighthNoteTime);

        // Play the hi-hat every eighthh note.
        for (var i = 0; i < 8; ++i) {
          playSound(hihat, time + i * eighthNoteTime);
        }
      }
    };
  </script>
</body>
</html>