<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Over the Kit</title>
  <script type="text/javascript" src="https://unpkg.com/vexflow@3.0.9/releases/vexflow-min.js"></script>
  <script type="text/javascript" src="js/fraction.min.js"></script>
  <script type="text/javascript" src="js/bufferLoader.js"></script>
  <script type="text/javascript" src="js/drumsetAudioBuffers.js"></script>
  <script type="text/javascript" src="js/GrooveGenerator.js"></script>
  <script type="text/javascript" src="js/StickingPadder.js"></script>
  <script type="text/javascript" src="js/Orchestrator.js"></script>
  <script type="text/javascript" src="js/Player.js"></script>
  <script type="text/javascript" src="js/Notator.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/tailwindcss@^1.5/dist/base.min.css">
  <link rel="stylesheet" href="https://unpkg.com/tailwindcss@^1.5/dist/components.min.css">
  <link rel="stylesheet" href="https://unpkg.com/@tailwindcss/typography@0.2.x/dist/typography.min.css">
  <link rel="stylesheet" href="https://unpkg.com/tailwindcss@^1.5/dist/utilities.min.css">
</head>
<body class="bg-gray-200">
  <div class="container mx-auto prose text-center py-10">
    <div class="shadow-md rounded bg-white py-12 px-10 md:px-16 prose-lg">
      <h1>ü•Å Over the Kit</h1>
      <div class="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-10 md:hidden" role="alert">
        <span class="font-bold">On a mobile device?</span>
        <span>Remember to turn off silent mode!</span>
      </div>
      <div class="flex flex-col space-y-10">
        <div class="mw-1/2">Discover a new chop to practice!</div>

        <form id="shuffleForm" class="my-4 space-y-10 md:space-y-4">
          <div class="md:flex md:items-center md:justify-center">
            <div class="md:w-1/3">
              <label class="block text-gray-500 font-bold md:text-right mb-1 md:mb-0 pr-4" for="sticking">
                Sticking:
              </label>
            </div>
            <div class="md:w-2/3">
              <input
                id="sticking"
                value="RLRLK"
                maxlength="16"
                minlength="3"
                class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-purple-500"
                type="text"
              >
            </div>
          </div>
          <div class="md:flex md:items-start">
            <div class="md:w-1/3">
              <label class="block text-gray-500 font-bold md:text-right mb-1 md:mb-0 pr-4" for="sticking">
                Orchestrations:
              </label>
            </div>
            <div class="md:w-2/3 pl-2 text-left">
              <div class="mb-2 flex">
                <div class="w-1/2">
                  <label class="md:w-full block text-gray-500 font-bold">
                    <input id="hihatCheckbox" class="mr-2 leading-tight" checked type="checkbox">
                    <span class="text-sm">
                      Hi-Hat
                    </span>
                  </label>
                </div>
                <div class="w-1/2">
                  <label class="md:w-full block text-gray-500 font-bold">
                    <input id="snareCheckbox" class="mr-2 leading-tight" checked type="checkbox">
                    <span class="text-sm">
                      Snare
                    </span>
                  </label>
                </div>
              </div>
              <div class="mb-2 flex">
                <div class="w-1/2">
                  <label class="md:w-full block text-gray-500 font-bold">
                    <input id="hiTomCheckbox" class="mr-2 leading-tight" checked type="checkbox">
                    <span class="text-sm">
                      Hi-Tom
                    </span>
                  </label>
                </div>
                <div class="w-1/2">
                  <label class="md:w-full block text-gray-500 font-bold">
                    <input id="midTomCheckbox" class="mr-2 leading-tight" type="checkbox">
                    <span class="text-sm">
                      Mid-Tom
                    </span>
                  </label>
                </div>
              </div>
              <div class="mb-2 flex">
                <div class="w-1/2">
                  <label class="md:w-full block text-gray-500 font-bold">
                    <input id="floorTomCheckbox" class="mr-2 leading-tight" checked type="checkbox">
                    <span class="text-sm">
                      Floor-Tom
                    </span>
                  </label>
                </div>
                <div class="w-1/2">
                  <label class="md:w-full block text-gray-500 font-bold">
                    <input class="mr-2 leading-tight" type="checkbox" checked disabled>
                    <span class="text-sm">
                      Kick
                    </span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="md:flex md:items-center md:justify-center">
            <div class="md:w-1/3">
              <label class="block text-gray-500 font-bold md:text-right mb-1 md:mb-0 pr-4" for="sticking">
                Tempo:
              </label>
            </div>
            <div class="md:w-2/3 mb-4 md:mb-auto">
              <input
                id="tempo"
                value="120"
                max="400"
                type="number"
                class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-purple-500"
              >
            </div>
          </div>
          <div class="md:flex md:items-center">
            <div class="md:w-1/3 hidden md:block">&nbsp;</div>
            <div class="md:w-2/3 text-left">
              <button class="shadow bg-purple-500 hover:bg-purple-400 focus:shadow-outline focus:outline-none text-white font-bold py-2 px-4 rounded w-full md:w-auto inline-flex items-center justify-center" type="submit">
                <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path class="heroicon-ui" d="M6 18.7V21a1 1 0 0 1-2 0v-5a1 1 0 0 1 1-1h5a1 1 0 1 1 0 2H7.1A7 7 0 0 0 19 12a1 1 0 1 1 2 0 9 9 0 0 1-15 6.7zM18 5.3V3a1 1 0 0 1 2 0v5a1 1 0 0 1-1 1h-5a1 1 0 0 1 0-2h2.9A7 7 0 0 0 5 12a1 1 0 1 1-2 0 9 9 0 0 1 15-6.7z"/></svg>
                <span>Generate</span>
              </button>
            </div>
          </div>
        </form>
        <div class="border-solid border-t border-gray-300">
          <h2>Fill (16th Notes)</h2>
          <div id="fill16" class="flex justify-center mb-4"></div>
          <button id="fill16Play" class="shadow bg-purple-200 hover:bg-purple-100 focus:shadow-outline focus:outline-none text-purple-600 font-bold py-2 px-4 rounded w-full md:w-auto inline-flex items-center justify-center md:ml-2 mt-2 md:mt-auto" type="button">
            <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path class="heroicon-ui" d="M8 14.54V6a1 1 0 0 1 .76-.97l12-3A1 1 0 0 1 22 3v12a4 4 0 1 1-2-3.46V4.28l-10 2.5V18a4 4 0 1 1-2-3.46zM6 20a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm12-3a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>
            <span>Play</span>
          </button>
        </div>
        <div class="border-solid border-t border-gray-300">
          <h2>One Bar Fill (16th Notes)</h2>
          <div id="1BarFill16" class="flex justify-center"></div>
          <button id="1BarFill16Play" class="shadow bg-purple-200 hover:bg-purple-100 focus:shadow-outline focus:outline-none text-purple-600 font-bold py-2 px-4 rounded w-full md:w-auto inline-flex items-center justify-center md:ml-2 mt-2 md:mt-auto" type="button">
            <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path class="heroicon-ui" d="M8 14.54V6a1 1 0 0 1 .76-.97l12-3A1 1 0 0 1 22 3v12a4 4 0 1 1-2-3.46V4.28l-10 2.5V18a4 4 0 1 1-2-3.46zM6 20a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm12-3a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>
            <span>Play</span>
          </button>
        </div>
        <div class="border-solid border-t border-gray-300">
          <h2>One Bar Fill (16th Note Triplets)</h2>
          <div id="1BarFill16Triplets" class="flex justify-center"></div>
          <button id="1BarFill16TripletsPlay" class="shadow bg-purple-200 hover:bg-purple-100 focus:shadow-outline focus:outline-none text-purple-600 font-bold py-2 px-4 rounded w-full md:w-auto inline-flex items-center justify-center md:ml-2 mt-2 md:mt-auto" type="button">
            <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path class="heroicon-ui" d="M8 14.54V6a1 1 0 0 1 .76-.97l12-3A1 1 0 0 1 22 3v12a4 4 0 1 1-2-3.46V4.28l-10 2.5V18a4 4 0 1 1-2-3.46zM6 20a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm12-3a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>
            <span>Play</span>
          </button>
        </div>
      </div>
    </div>
    <div class="text-gray-500 px-10 md:px-16">
      <h2>üëã<span class="ml-2 text-gray-600">Hey there!</span></h2>
      <p class="text-center">
        If you enjoyed this and have a suggestion, or want to be notified as I add more features, please drop a note <a class="underline hover:text-gray-700" href="https://forms.gle/R4ZryX4fbvmBrz5TA" target="_blank" rel="noopener noreferrer">here</a>.
      </p>
      <h3><span class="text-gray-600">Roadmap:</span></h3>
      <div>Generate different stickings</div>
      <div>Over-the-bar / sub-bar patterns</div>
      <div>Save and share patterns</div>
      <div>More orchestrations / flavours e.g. rests, accents</div>
      <div>üëâ<em class="ml-2">Your idea here?</em></div>
      <p>
        <small>
          a project by <a href="https://github.com/wasabigeek">wasabigeek</a>
        </small>
      </p>
    </div>
  </div>
  <script type="text/javascript">
    window.onload = init;
    var audioContext;
    var drumset;
    DURATION_SIXTEENTH = '1/16';
    DURATION_SIXTEENTH_TRIPLET = '1/24';
    DURATION_EIGHTH = '1/8';
    DURATION_QUARTER = '1/4';

    var scores = {
      'fill16': new Score(),
      '1BarFill16': new Score(),
      '1BarFill16Triplets': new Score(),
    }

    function Score(noteGroups = [], options = {}) {
      this.noteGroups = noteGroups;
      this.options = options;  // for copying
      this.timeSignature = options.timeSignature || '4/4';

      this.getBeatValue = function() {
        return new Fraction(1 / Number(this.timeSignature.split('/')[1]));
      }

      this.slice = function(start, end) {
        return new Score(this.noteGroups.slice(start, end), this.options);
      }

      this.sliceDuration = function(start, end) {
        start = new Fraction(start);
        end = new Fraction(end);

        var sliced = [];
        var copy = this.noteGroups.slice();
        var cumulativeDuration = new Fraction(0);
        while(cumulativeDuration < end && copy.length > 0) {
          var next = copy.shift();

          // have we reached the end?
          if (next && (end.sub(cumulativeDuration)) >= next.duration) {
            // is this from the start that we wanted to slice?
            if (cumulativeDuration >= start) {
              sliced.push(next);
            }
            cumulativeDuration = cumulativeDuration.add(next.duration);
          }
        }

        return new Score(sliced, this.options);
      }

      this.concat = function(score) {
        return new Score(this.noteGroups.slice().concat(score.noteGroups), this.options);
      }

      this.forEach = function(fn) {
        this.noteGroups.forEach(fn);
      }

      this.push = function(noteGroup) {
        this.noteGroups.push(noteGroup);
      }

      this.sumDuration = function() {
        return this.noteGroups.reduce(function(acc, noteGroup) {
          return acc.add(noteGroup.duration);
        }, new Fraction(0));
      }
    }

    function Note(options) {
      this.instrument = options.instrument;
      this.volume = options.volume;

      this.verticalPosition = this.instrument.verticalPosition;
      // this has to be lazily retrieved now because the AudioContext needs to load
      this.getSound = this.instrument.sound;
    }

    function NoteGroup(notes, duration) {
      this.notes = notes;
      this.duration = new Fraction(duration);

      this.setDuration = function(duration) {
        this.duration = new Fraction(duration);
      }
    }

    function Drumset(audioBuffers, positions) {
      this.snare = { verticalPosition: positions.SNARE, sound: audioBuffers.snareSound };
      this.hihat = { verticalPosition: positions.CLOSED_HIHAT, sound: audioBuffers.hihatSound };
      this.kick = { verticalPosition: positions.KICK, sound: audioBuffers.kickSound };
      this.tom1 = { verticalPosition: positions.HI_TOM, sound: audioBuffers.tom1Sound };
      this.tom2 = { verticalPosition: positions.MID_TOM, sound: audioBuffers.tom2Sound };
      this.tom3 = { verticalPosition: positions.FLOOR_TOM, sound: audioBuffers.tom3Sound };
    }

    function init() {
      // Audio setup
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      audioContext = new AudioContext();

      var drumsetAudioBuffers = new DrumsetAudioBuffers(audioContext);

      var scoreGenerators = {
        'fill16': generateScore,
        '1BarFill16': generateScoreBar,
        '1BarFill16Triplets': generateScoreTriplets
      }
      var notators = {
        'fill16': new Notator({ elementId: 'fill16' }),
        '1BarFill16': new Notator({ elementId: '1BarFill16', height: 300 }),
        '1BarFill16Triplets': new Notator({ elementId: '1BarFill16Triplets', width: 500, height: 300 }),
      }
      var player = new Player({ audioContext: audioContext })

      drumset = new Drumset(drumsetAudioBuffers, NOTATOR_POSITIONS);

      function getOrchestrations() {
        var orchestrations = [];
        // this is coupled to the UI / instruments for simplicity, might want to relook this
        if (document.getElementById('hihatCheckbox').checked) { orchestrations.push(drumset.hihat) }
        if (document.getElementById('snareCheckbox').checked) { orchestrations.push(drumset.snare) }
        if (document.getElementById('hiTomCheckbox').checked) { orchestrations.push(drumset.tom1) }
        if (document.getElementById('midTomCheckbox').checked) { orchestrations.push(drumset.tom2) }
        if (document.getElementById('floorTomCheckbox').checked) { orchestrations.push(drumset.tom3) }

        return orchestrations;
      }

      // FIXME: refactor
      function generateScore(sticking, options = {}) {
        var orchestrations = options.orchestrations || getOrchestrations();

        var newScore = new Orchestrator({ drumset: drumset, allowedOrchestrations: orchestrations })
          .orchestrate(sticking);

        newScore.forEach(function(grouping) {
          grouping.setDuration(DURATION_SIXTEENTH);
        });

        var duration = newScore.sumDuration();
        var groove = new GrooveGenerator({ drumset: drumset }).generate({ duration: 1 - duration });

        return groove.concat(newScore);
      }

      // FIXME: refactor
      function generateScoreBar(sticking, options = {}) {
        var orchestrations = options.orchestrations || getOrchestrations();

        var newSticking = new StickingPadder().pad(sticking);

        var newScore = new Orchestrator({ drumset: drumset, allowedOrchestrations: orchestrations })
          .orchestrate(newSticking);

        newScore.forEach(function(grouping) {
          grouping.setDuration(DURATION_SIXTEENTH);
        });

        var duration = newScore.sumDuration();
        var groove = new GrooveGenerator({ drumset: drumset }).generate({ duration: 2 - duration });

        return groove.concat(newScore);
      }

      // FIXME: refactor
      function generateScoreTriplets(sticking, options = {}) {
        var orchestrations = options.orchestrations || getOrchestrations();

        var newSticking = new StickingPadder({ length: 24 }).pad(sticking);

        var newScore = new Orchestrator({ drumset: drumset, allowedOrchestrations: orchestrations })
          .orchestrate(newSticking);

        newScore.forEach(function(grouping) {
          grouping.setDuration(DURATION_SIXTEENTH_TRIPLET);
        });

        var duration = newScore.sumDuration();
        var groove = new GrooveGenerator({ drumset: drumset }).generate({ duration: 2 - duration });

        return groove.concat(newScore);
      }

      var newSticking = document.getElementById('sticking').value;
      for (var scoreKey in scores) {
        scores[scoreKey] = scoreGenerators[scoreKey](newSticking);
        notators[scoreKey].generateNotation(scores[scoreKey]);
      }

      // events
      var createClickHandler = function(scoreKey) {
        return function(e) {
          var tempo = document.getElementById('tempo').value;
          player.play(scores[scoreKey], { tempo: tempo })
        }
      }
      for (var scoreKey in scores) {
        document.getElementById(scoreKey + 'Play').onclick = createClickHandler(scoreKey); // scope scoreKey to the function
      }

      document.getElementById('shuffleForm').onsubmit = function(e) {
        e.preventDefault();
        var newSticking = document.getElementById('sticking').value;
        for (var scoreKey in scores) {
          scores[scoreKey] = scoreGenerators[scoreKey](newSticking);
          notators[scoreKey].generateNotation(scores[scoreKey]);
        }
      }
    }
  </script>
</body>
</html>